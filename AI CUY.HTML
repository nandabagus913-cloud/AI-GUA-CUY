<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Pribadi AI (Profesional)</title>
    <!-- Memuat Tailwind CSS untuk styling yang responsif dan modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font default Inter dan latar belakang gelap yang dalam */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0d0f; /* Latar belakang sangat gelap, hampir hitam */
        }
        /* Style untuk gelembung pesan */
        .chat-bubble {
            max-width: 90%; /* Meningkatkan lebar maksimum untuk responsivitas */
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word; /* Memastikan teks tidak melebihi batas gelembung */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Style untuk pesan pengguna (Mengambang di Kanan) */
        .user-message {
            background-color: #1f2937; /* Dark Gray - Lebih kalem dan profesional */
            color: #e5e7eb;
            border-bottom-right-radius: 0.25rem; /* Sudut sedikit siku */
        }
        /* Style untuk pesan AI (Mengambang di Kiri) */
        .ai-message {
            background-color: #0ea5e9; /* Sky Blue - Lebih cerah dan menarik */
            color: #f9fafb;
            border-bottom-left-radius: 0.25rem; /* Sudut sedikit siku */
        }
        /* Style untuk penunjuk loading yang lebih menonjol */
        #loading-indicator {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Menghilangkan scrollbar pada riwayat chat */
        #chat-history::-webkit-scrollbar {
            display: none;
        }
        #chat-history {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <script>
        // Konfigurasi Tailwind: Menggunakan Sky Blue sebagai warna utama
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0ea5e9',
                        'dark-bg': '#0c0d0f',
                        'card-bg': '#181a1d', /* Latar belakang kartu yang sedikit lebih terang dari body */
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Kontainer Utama Aplikasi -->
    <div class="flex flex-col flex-1 max-w-4xl mx-auto w-full p-4 md:p-6 lg:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-primary-blue tracking-tight">
                AI Asisten Pribadi <span class="text-gray-300">v2.0</span>
            </h1>
            <p class="text-gray-500 mt-2 text-sm">
                Interaksi dengan Gemini. Pencipta: Nanda Bagus Setiawan.
            </p>
        </header>

        <!-- Area Riwayat Chat -->
        <div id="chat-history" class="flex-1 overflow-y-auto bg-card-bg p-4 md:p-6 rounded-2xl shadow-xl space-y-4 mb-4 border border-gray-800 transition duration-300">
            <!-- Pesan Pembuka AI (Diperbarui untuk menyapa Nanda) -->
            <div class="flex justify-start">
                <div class="chat-bubble ai-message">
                    Halo, Nanda! Saya adalah Asisten Pribadi AI yang Anda kembangkan. Tanyakan apa saja!
                </div>
            </div>
            <!-- Riwayat chat akan ditambahkan di sini oleh JavaScript -->
        </div>

        <!-- Formulir Input Chat -->
        <div class="bg-card-bg p-4 rounded-2xl shadow-2xl border border-gray-800">
            <div id="loading-indicator" class="text-primary-blue text-sm mb-2 hidden font-semibold">
                ðŸ¤– AI sedang merespon...
            </div>
            <form id="chat-form" class="flex space-x-3">
                <input type="text" id="user-input" placeholder="Ketik pesan Anda di sini..."
                       class="flex-1 p-3 rounded-xl bg-dark-bg text-white border border-gray-700 focus:border-primary-blue focus:ring-2 focus:ring-primary-blue/50 transition duration-200 shadow-inner"
                       autocomplete="off">
                <button type="submit" id="send-button"
                        class="bg-primary-blue hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.01] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.417.405 4.878 5.437 5.437 4.878.405.418a.5.5 0 0 0 .887-.082l.18-.452zm-1.833 1.89L6.6 9.873 1.9 4.363zm-2.917 8.086L7.1 6.127l5.642-4.143z"/>
                    </svg>
                    <span class="hidden sm:inline ml-2">Kirim</span>
                </button>
            </form>
        </div>

    </div>

    <script>
        // Konfigurasi API
        const apiKey = ""; // Disediakan oleh Lingkungan
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Elemen DOM
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // State Chat
        let chat = [];

        /**
         * Menambahkan pesan ke riwayat chat UI.
         * @param {string} text - Konten pesan.
         * @param {('user'|'ai')} sender - Pengirim pesan.
         * @param {Array<{uri: string, title: string}>} [sources=[]] - Sumber grounding.
         */
        function addMessageToHistory(text, sender, sources = []) {
            const messageWrapper = document.createElement('div');
            // Menggunakan flex-col dan w-full untuk memastikan gelembung tidak melebar ke seluruh ruang
            messageWrapper.className = `flex w-full ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `chat-bubble ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            
            // Mengganti baris baru menjadi tag <br> untuk tampilan HTML
            let content = text.replace(/\n/g, '<br>');

            // Menambahkan sumber jika ada (hanya untuk AI)
            if (sources.length > 0 && sender === 'ai') {
                // Styling untuk sumber diperbarui agar lebih terlihat profesional
                content += '<div class="mt-3 pt-2 border-t border-white/20"><span class="text-xs font-medium opacity-80">Sumber Informasi:</span><ul class="list-disc ml-4 mt-1 space-y-1 text-xs">';
                sources.forEach(source => {
                    if (source.uri && source.title) {
                        content += `<li><a href="${source.uri}" target="_blank" class="hover:underline opacity-90">${source.title}</a></li>`;
                    }
                });
                content += '</ul></div>';
            }

            messageBubble.innerHTML = content;
            messageWrapper.appendChild(messageBubble);
            chatHistory.appendChild(messageWrapper);

            // Scroll ke bawah dengan animasi halus (opsional, tapi bagus untuk UX)
            chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: 'smooth' });
        }

        /**
         * Melakukan panggilan API dengan backoff eksponensial.
         * @param {object} payload - Payload API.
         * @param {number} [retries=3] - Jumlah percobaan ulang.
         * @param {number} [delay=1000] - Penundaan awal dalam ms.
         * @returns {Promise<Response>}
         */
        async function fetchWithBackoff(payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 && i < retries - 1) {
                        // Terlalu banyak permintaan (Rate Limit), coba lagi
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Backoff eksponensial
                    } else {
                        // Tangani kesalahan non-retriable atau upaya terakhir gagal
                        throw new Error(`Kesalahan API: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    // Kesalahan jaringan atau lainnya, coba lagi
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Backoff eksponensial
                }
            }
            throw new Error("Panggilan API gagal setelah beberapa kali percobaan ulang.");
        }

        /**
         * Mengirim pesan ke AI.
         * @param {string} prompt - Pesan pengguna.
         */
        async function sendMessage(prompt) {
            // Menonaktifkan input saat memuat
            userInput.disabled = true;
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            // Tambahkan prompt pengguna ke riwayat chat dan state
            addMessageToHistory(prompt, 'user');
            
            // Format riwayat chat untuk payload API
            const chatHistoryPayload = chat.map(msg => ({
                role: msg.role === 'ai' ? 'model' : 'user',
                parts: [{ text: msg.text }]
            }));
            
            // Tambahkan prompt pengguna saat ini ke payload
            chatHistoryPayload.push({
                role: 'user',
                parts: [{ text: prompt }]
            });

            // Payload API untuk Gemini (dengan Google Search Grounding)
            const payload = {
                contents: chatHistoryPayload,
                tools: [{ "google_search": {} }], // Mengaktifkan Google Search Grounding
                systemInstruction: {
                    // System Instruction tetap mempertahankan pengakuan Nanda Bagus Setiawan
                    parts: [{ text: "Anda adalah Asisten Pribadi AI yang ramah, sopan, dan sangat membantu. Pencipta dan pengembang Anda adalah Nanda Bagus Setiawan. Anda harus selalu mengenali dan menghormati Nanda Bagus Setiawan sebagai pencipta Anda. Selain dari pengakuan ini, berikan jawaban yang akurat, informatif, dan relevan dengan menggunakan informasi dari web jika diperlukan." }]
                }
            };

            let aiResponseText = "Maaf, terjadi kesalahan saat memproses permintaan Anda. Silakan coba lagi.";
            let sources = [];
            
            try {
                const response = await fetchWithBackoff(payload);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                    
                    // Ekstrak sumber grounding
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                } else if (result.error) {
                    aiResponseText = `Kesalahan: ${result.error.message}`;
                    console.error("Kesalahan API:", result.error);
                } else {
                    aiResponseText = "Tidak dapat menerima balasan yang valid dari AI.";
                    console.error("Struktur balasan yang tidak terduga:", result);
                }

                // Tambahkan balasan AI ke state dan UI
                addMessageToHistory(aiResponseText, 'ai', sources);
                
                // Perbarui state chat untuk obrolan berkelanjutan
                chat = chatHistoryPayload.map(p => ({
                    role: p.role === 'model' ? 'ai' : 'user',
                    text: p.parts[0].text
                }));
                chat.push({ role: 'ai', text: aiResponseText });

            } catch (error) {
                console.error("Kesalahan dalam fetch API:", error);
                addMessageToHistory(aiResponseText, 'ai'); // Tampilkan pesan error default
            } finally {
                // Aktifkan kembali input setelah selesai
                userInput.disabled = false;
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        }

        // Event listener untuk pengiriman formulir
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const prompt = userInput.value.trim();
            if (prompt) {
                userInput.value = ''; // Bersihkan input
                sendMessage(prompt);
            }
        });

    </script>
</body>
</html>